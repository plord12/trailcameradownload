name: Go package

on: [push]

jobs:
  build:

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: 1.19

      - name: Install opencv
        run: sudo apt-get install libopencv-dev

      - name: Build tensorflow lite
        run: |
          set -x
          #sudo apt-get install cmake
          sudo curl -L -o /usr/local/bin/bazel https://github.com/bazelbuild/bazelisk/releases/download/v1.16.0/bazelisk-linux-amd64 
          sudo chmod a+x /usr/local/bin/bazel
          export USE_BAZEL_VERSION=5.1.1
          git clone https://github.com/tensorflow/tensorflow.git tensorflow_src
          cd tensorflow_src
          git checkout v2.11.0
          bazel clean
          bazel build -c opt --config monolithic  --define tflite_with_xnnpack=true --define tflite_keep_symbols=true --define arm64-v8a=true --define if_enable_acl=true --copt -DCL_DELEGATE_NO_GL --copt -DEGL_NO_X11 --copt -DMESA_EGL_NO_X11_HEADERS //tensorflow/lite:libtensorflowlite.so //tensorflow/lite/c:libtensorflowlite_c.so //tensorflow/lite/delegates/gpu/cl:gpu_api_delegate //tensorflow/lite/delegates/gpu:libtensorflowlite_gpu_delegate.so
          sudo cp bazel-bin/tensorflow/lite/*so /usr/local/lib
          sudo cp bazel-bin/tensorflow/lite/c/*so /usr/local/lib
          sudo cp bazel-bin/tensorflow/lite/delegates/gpu/*.so /usr/local/lib
          sudo cp bazel-bin/tensorflow/lite/delegates/gpu/cl/*.so /usr/local/lib
          #sudo cp /home/plord/src/tensorflow/tensorflow_src/bazel-bin/tensorflow/lite/delegates/xnnpack/*.a /usr/local/lib
          sudo mkdir -p /usr/local/include/tensorflow/lite
          sudo cp tensorflow/lite/*.h /usr/local/include/tensorflow/lite
          sudo mkdir -p /usr/local/include/tensorflow/lite/c
          sudo cp tensorflow/lite/c/*.h /usr/local/include/tensorflow/lite/c
          sudo mkdir -p /usr/local/include/tensorflow/lite/delegates/xnnpack
          sudo cp tensorflow/lite/delegates/xnnpack/*.h /usr/local/include/tensorflow/lite/delegates/xnnpack
          sudo mkdir -p /usr/local/include/tensorflow/lite/delegates/gpu/cl
          sudo cp tensorflow/lite/delegates/gpu/*.h /usr/local/include/tensorflow/lite/delegates/gpu
          sudo cp tensorflow/lite/delegates/gpu/cl/*.h /usr/local/include/tensorflow/lite/delegates/gpu/cl
          sudo mkdir -p /usr/local/include/tensorflow/lite/core/c
          sudo cp tensorflow/lite/core/c/*.h /usr/local/include/tensorflow/lite/core/c
          # cd ..
          # mkdir tflite_build
          # cd tflite_build
          # cmake ../tensorflow_src/tensorflow/lite -DTFLITE_ENABLE_XNNPACK=1 -DBUILD_SHARED_LIBS=1
          # cmake --build . -j 4
          # cd ..
          # mkdir tflite_c_build
          # cd tflite_c_build
          # cmake ../tensorflow_src/tensorflow/lite/c -DTFLITE_ENABLE_XNNPACK=1 -DBUILD_SHARED_LIBS=1
          # cmake --build . -j 4
          # cd ..
          # sudo mkdir -p /usr/local/include/tensorflow/lite/c /usr/local/include/tensorflow/lite/core/c /usr/local/include/tensorflow/lite/delegates/xnnpack
          # sudo cp tensorflow_src/tensorflow/lite/*.h /usr/local/include/tensorflow/lite
          # sudo cp tensorflow_src/tensorflow/lite/core/c/*.h /usr/local/include/tensorflow/lite/core/c
          # sudo cp tensorflow_src/tensorflow/lite/delegates/xnnpack/*.h /usr/local/include/tensorflow/lite/delegates/xnnpack
          #Â 
          # sudo cp tensorflow_src/tensorflow/lite/c/*.h /usr/local/include/tensorflow/lite/c
          # sudo cp tflite_build/*.so /usr/local/lib
          # sudo cp tflite_c_build/*.so /usr/local/lib/

      - name: Run tests
        run: |
          set -x
          rm -f /tmp/detected*.jpg
          mkdir -p bin
          CGO_LDFLAGS=-L/usr/local/lib GOARCH=amd64 GOOS=linux go build -x -o bin/trailcameradownload-linux-amd64
          ldd bin/trailcameradownload-linux-amd64
          CGO_LDFLAGS=-L/usr/local/lib go test -x -v

      - name: Create montage
        run: montage /tmp/detected*.jpg -geometry 1024x1024+2+2 montage.jpg

      - name: Archive montage
        uses: actions/upload-artifact@v3
        with:
          name: montage
          path: montage.jpg